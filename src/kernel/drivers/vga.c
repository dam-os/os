#include "../lib/print.h"
#include "../memory/memory.h"
#include "pci.h"

// Mostly port of
// https://github.com/neri/riscv-vga-sample

void draw_pixel(uintptr_t fb_base, int x, int y, uint8_t color) {
    volatile uint8_t *fb = (volatile uint8_t *)fb_base;
    int offset = (y * 320) + x;
    fb[offset] = color;  // Write color value
}

void clear_screen(uintptr_t fb_base) {
    for (int i = 0; i < (320 * 200); i++) {
        ((volatile uint8_t *)fb_base)[i] = 0; // Set all pixels to black
    }
}

// Structure to hold the (vport, index, data) values
typedef struct {
    uint8_t vport;
    uint8_t index;
    uint8_t data;
} Mode13Reg;

// Array of register values for setting mode 13h
static const Mode13Reg MODE_13_REGS[28] = {
    {0xC2, 0x00, 0x63},
    {0xD4, 0x11, 0x0E},
    {0xD4, 0x00, 0x5F},
    {0xD4, 0x01, 0x4F},
    {0xD4, 0x02, 0x50},
    {0xD4, 0x03, 0x82},
    {0xD4, 0x04, 0x54},
    {0xD4, 0x05, 0x80},
    {0xD4, 0x06, 0xBF},
    {0xD4, 0x07, 0x1F},
    {0xD4, 0x08, 0x00},
    {0xD4, 0x09, 0x41},
    {0xD4, 0x10, 0x9C},
    {0xD4, 0x11, 0x8E},
    {0xD4, 0x12, 0x8F},
    {0xD4, 0x13, 0x28},
    {0xD4, 0x14, 0x40},
    {0xD4, 0x15, 0x96},
    {0xD4, 0x16, 0xB9},
    {0xD4, 0x17, 0xA3},
    {0xC4, 0x01, 0x01},
    {0xC4, 0x02, 0x0F},
    {0xC4, 0x04, 0x0E},
    {0xCE, 0x00, 0x00},
    {0xCE, 0x05, 0x40},
    {0xCE, 0x06, 0x05},
    {0xC0, 0x30, 0x41},
    {0xC0, 0x33, 0x00}
};

static const uint32_t PALETTE[256] = {
    0x4059bd, 0xffffff, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000
};    
        
// Run-length encoded image
static const int compressed_image[] = {
    24047, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 24, 24, 16, 16, 8, 24, 8, 32, 16, 24, 24, 104, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 8, 16, 8, 8, 16, 8, 16, 24, 8, 16, 8, 8, 8, 128, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 32, 8, 8, 8, 8, 8, 8, 24, 8, 16, 8, 16, 16, 112, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 8, 16, 8, 8, 8, 16, 8, 8, 8, 24, 8, 24, 8, 16, 8, 32, 8, 104, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 112, 24, 16, 8, 16, 8, 8, 8, 24, 8, 32, 16, 16, 24, 12893, 6, 4, 2, 6, 2, 6, 6, 6, 4, 4, 2, 6, 2, 2, 6, 2, 6, 18, 4, 4, 2, 8, 8, 2, 2, 4, 2, 4, 4, 4, 2, 4, 2, 2, 6, 4, 8, 2, 6, 10, 4, 4, 2, 4, 2, 2, 6, 8, 2, 6, 2, 4, 4, 4, 6, 4, 6, 2, 2, 4, 2, 4, 6, 46, 6, 4, 2, 6, 2, 6, 6, 6, 4, 4, 2, 6, 2, 2, 6, 2, 6, 18, 4, 4, 2, 8, 8, 2, 2, 4, 2, 4, 4, 4, 2, 4, 2, 2, 6, 4, 8, 2, 6, 10, 4, 4, 2, 4, 2, 2, 6, 8, 2, 6, 2, 4, 4, 4, 6, 4, 6, 2, 2, 4, 2, 4, 6, 46, 2, 4, 2, 2, 2, 6, 2, 6, 2, 4, 2, 2, 2, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 4, 2, 14, 2, 4, 2, 2, 2, 8, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 4, 2, 2, 2, 2, 4, 2, 2, 2, 8, 2, 4, 2, 6, 2, 4, 2, 2, 4, 2, 2, 2, 2, 4, 2, 6, 4, 2, 4, 2, 2, 4, 2, 2, 2, 4, 2, 4, 2, 4, 2, 4, 2, 2, 2, 52, 2, 4, 2, 2, 2, 6, 2, 6, 2, 4, 2, 2, 2, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 4, 2, 14, 2, 4, 2, 2, 2, 8, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 4, 2, 2, 2, 2, 4, 2, 2, 2, 8, 2, 4, 2, 6, 2, 4, 2, 2, 4, 2, 2, 2, 2, 4, 2, 6, 4, 2, 4, 2, 2, 4, 2, 2, 2, 4, 2, 4, 2, 4, 2, 4, 2, 2, 2, 52, 6, 6, 6, 8, 2, 4, 2, 2, 8, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 14, 8, 2, 2, 8, 6, 6, 4, 4, 8, 2, 2, 2, 4, 2, 2, 4, 2, 2, 6, 4, 6, 8, 8, 2, 2, 2, 4, 2, 2, 4, 2, 6, 2, 2, 2, 2, 2, 2, 8, 2, 6, 6, 2, 4, 2, 4, 2, 4, 4, 48, 6, 6, 6, 8, 2, 4, 2, 2, 8, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 14, 8, 2, 2, 8, 6, 6, 4, 4, 8, 2, 2, 2, 4, 2, 2, 4, 2, 2, 6, 4, 6, 8, 8, 2, 2, 2, 4, 2, 2, 4, 2, 6, 2, 2, 2, 2, 2, 2, 8, 2, 6, 6, 2, 4, 2, 4, 2, 4, 4, 48, 2, 4, 2, 6, 2, 10, 2, 4, 2, 2, 2, 4, 2, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 4, 2, 8, 2, 4, 2, 2, 2, 8, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 8, 2, 2, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 6, 2, 6, 2, 2, 2, 4, 2, 2, 2, 2, 2, 6, 2, 4, 2, 4, 2, 8, 2, 46, 2, 4, 2, 6, 2, 10, 2, 4, 2, 2, 2, 4, 2, 4, 2, 2, 2, 6, 2, 4, 2, 4, 2, 4, 2, 8, 2, 4, 2, 2, 2, 8, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 8, 2, 2, 2, 8, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 6, 2, 6, 2, 2, 2, 4, 2, 2, 2, 2, 2, 6, 2, 4, 2, 4, 2, 8, 2, 46, 6, 8, 2, 10, 6, 4, 2, 4, 2, 6, 2, 6, 6, 2, 6, 6, 2, 8, 2, 4, 2, 2, 8, 2, 8, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 6, 4, 8, 2, 2, 4, 2, 6, 2, 4, 2, 2, 2, 4, 2, 2, 6, 8, 2, 6, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 6, 4, 4, 4, 6, 48, 6, 8, 2, 10, 6, 4, 2, 4, 2, 6, 2, 6, 6, 2, 6, 6, 2, 8, 2, 4, 2, 2, 8, 2, 8, 2, 2, 4, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 6, 4, 8, 2, 2, 4, 2, 6, 2, 4, 2, 2, 2, 4, 2, 2, 6, 8, 2, 6, 2, 2, 2, 4, 2, 2, 2, 4, 2, 2, 6, 4, 4, 4, 6
};
    
      

void init_virtio_vga() {
    uint8_t* fb_base = (uint8_t*)0x50000000;

    uint32_t* devbase = pci_get_addr(0, 16, 0, 0x0);
    uint32_t pci_class = (*(devbase + 2)) >> 8;

    if (pci_class != 0x030000) {
        cprintf("VGA not found\n");
    } else {
        cprintf("VGA device found\n");
    }

    *(devbase + 4) = 0xFFFFFFFF;

    uint32_t fb_size = (~(*(devbase + 4)) | 0xF) + 1;
    uint8_t* io_base = fb_base + fb_size;

    *(devbase + 6) = 0xFFFFFFFF;
    uint32_t io_size = (~(*(devbase + 6)) | 0xF) + 1;


    *(devbase + 4) = (uint32_t)(uintptr_t)(fb_base) | 8;
    *(devbase + 6) = (uint32_t)(uintptr_t)(io_base) | 8;

    uint32_t cmd = *(devbase + 1);
    *(devbase + 1) = cmd | 0x0002;

    cprintf("VGA fb_base %x size %dM io_base %x size %d\n", (uint32_t)(uintptr_t)fb_base, (fb_size + 0x80000) >> 20, (uint32_t)(uintptr_t)io_base, io_size);

    uint8_t * port0300 = (io_base + (0x400 - 0xC0));

    for (int i = 0; i < 28; i++) {
        uint8_t vport = MODE_13_REGS[i].vport;
        uint8_t index = MODE_13_REGS[i].index;
        uint8_t data = MODE_13_REGS[i].data;
        uint8_t * port = port0300 + vport;

        switch (vport) {
        case 0xC0:
            *(port0300 + 0xDA) = 0;

            *port = index;
            *port = data;
            break;

        case 0xC2:
            *port = data;
            break;

        default:
            *port = index;
            *(port + 1) = data;
            break;

        }
    }


    *(io_base + 0x406) = 0xFF;
    *(io_base + 0x408) = 0;

    uint8_t* p = io_base + 0x409;
    for (int i = 0; i < 256; i++) {
        uint8_t b = PALETTE[i] & 0xFF;
        uint8_t g = (PALETTE[i] >> 8) & 0xFF;
        uint8_t r = (PALETTE[i] >> 16) & 0xFF;

        *p = r;
        *p = g;
        *p = b;
    }
    memset((const char *)fb_base, 0, 320 * 200); 
    int c = 0;
    int index = 0;
    int count = 0;
    for (int i = 0; i < 64000; i++) {
        if (count == 0) {
            count = compressed_image[index++];
            c = !c;
        }
        fb_base[i] = c;
        count--;
    }
}

void debug_print_virtio() {
    uint8_t bus = 0, device = 16, function = 0;

    uint32_t reg0 = pci_read_word(bus, device, function, 0x00);
    uint32_t reg1 = pci_read_word(bus, device, function, 0x04);
    uint32_t reg2 = pci_read_word(bus, device, function, 0x08);
    uint32_t reg3 = pci_read_word(bus, device, function, 0x0C);  // New register


    uint16_t vendor_id = reg0 & 0xFFFF;
    uint16_t device_id = (reg0 >> 16) & 0xFFFF;
    uint16_t command = reg1 & 0xFFFF;
    uint16_t status = (reg1 >> 16) & 0xFFFF;
    uint8_t revision_id = reg2 & 0xFF;
    uint8_t prog_if = (reg2 >> 8) & 0xFF;
    uint8_t subclass = (reg2 >> 16) & 0xFF;
    uint8_t class_code = (reg2 >> 24) & 0xFF;

    uint8_t cache_line_size = reg3 & 0xFF;
    uint8_t latency_timer = (reg3 >> 8) & 0xFF;
    uint8_t header_type = (reg3 >> 16) & 0xFF;
    uint8_t bist = (reg3 >> 24) & 0xFF;

    cprintf("Device ID:        0x%x\n", device_id);
    cprintf("Vendor ID:        0x%x\n", vendor_id);
    cprintf("Command:          0x%x\n", command);
    cprintf("Status:           0x%b\n", status);
    cprintf("Class Code:       0x%x\n", class_code);
    cprintf("Subclass:         0x%x\n", subclass);
    cprintf("Programming IF:   0x%x\n", prog_if);
    cprintf("Revision ID:      0x%x\n", revision_id);
    cprintf("Cache Line Size:  0x%x (%d bytes)\n", cache_line_size, cache_line_size * 4);
    cprintf("Latency Timer:    0x%x\n", latency_timer);
    cprintf("Header Type:      0x%x\n", header_type);
    cprintf("BIST:             0x%x\n", bist);
}
